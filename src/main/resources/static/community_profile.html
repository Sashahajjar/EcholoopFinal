<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Profile - EchoLoop</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js" defer></script>
  <style>
    .feed-account-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }
  
    .feed-profile-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }
  
    .feed-profile-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent-secondary);
      margin-bottom: 16px;
    }
  
    .feed-profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
  
    .feed-profile-section {
      margin-bottom: 32px;
    }
  
    .feed-profile-section h4 {
      margin-bottom: 8px;
      font-size: 1.1em;
      color: var(--accent-primary);
    }
  
    .feed-button {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
  
    .feed-button:hover {
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
    }
  
    .feed-input,
    .feed-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 8px;
      margin-bottom: 12px;
    }
  
    .feed-profile-stats {
      display: flex;
      justify-content: space-around;
      background-color: var(--surface);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 32px;
      border: 1px solid var(--border);
    }
  
    .feed-stat h4 {
      margin: 0;
      font-size: 1em;
      color: var(--accent-primary);
    }
  
    .feed-stat p {
      margin: 4px 0 0;
      font-weight: 500;
    }
  
    .feed-lists-section {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
  
    .feed-following-list,
    .feed-followers-list {
      flex: 1;
      min-width: 300px;
    }
  
    ul {
      padding-left: 20px;
    }
  
    li {
      margin-bottom: 8px;
    }
  
    a {
      text-decoration: none;
      color: var(--accent-primary);
    }
  
    a:hover {
      text-decoration: underline;
    }
  
    .feed-post,
    .feed-event {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      background-color: var(--surface);
    }
  
    .feed-post-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
  
    .feed-no-activity {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
    }
  </style>
  
</head>
<body>
  <nav class="feed-navbar">
    <a href="feed.html" class="feed-logo">
      <img src="images/logoecho.png" alt="EchoLoop Logo" class="feed-logo-img" />
    </a>
    <div class="feed-nav-links">
      <!-- Navigation will be populated by JavaScript -->
    </div>
  </nav>

  <main class="feed-account-container">
    <div class="feed-profile-card">
      <img src="images/venue-profile.jpg" alt="Profile" class="feed-profile-img" />
      <button id="followBtn" class="feed-button" style="display: none;">Follow</button>

      <div class="feed-profile-details">
        <div class="feed-profile-header">
          <div>
            <h2 id="communityName">Loading...</h2>
            <p>Event Community</p>
          </div>
        </div>

        <div class="feed-profile-section">
          <h4>About</h4>
          <div id="aboutSection">
            <p id="communityAbout">Loading...</p>
            <button id="editAboutBtn" class="feed-button" style="display: none;">Edit</button>
          </div>
          <div id="aboutEditSection" style="display: none;">
            <textarea id="aboutInput" class="feed-textarea"></textarea>
            <button onclick="saveProfile()" class="feed-button">Save</button>
            <button onclick="cancelEdit()" class="feed-button">Cancel</button>
          </div>
        </div>

        <div class="feed-profile-section">
          <h4>Location</h4>
          <div id="locationSection">
            <p id="communityLocation">Loading...</p>
            <button id="editLocationBtn" class="feed-button" style="display: none;">Edit</button>
          </div>
          <div id="locationEditSection" style="display: none;">
            <input type="text" id="locationInput" class="feed-input" />
            <button onclick="saveProfile()" class="feed-button">Save</button>
            <button onclick="cancelEdit()" class="feed-button">Cancel</button>
          </div>
        </div>

        <div class="feed-profile-stats">
          <div class="feed-stat">
            <h4>Following</h4>
            <p id="followingCount">Loading...</p>
          </div>
          <div class="feed-stat">
            <h4>Followers</h4>
            <p id="followerCount">Loading...</p>
          </div>
        </div>

        <div class="feed-lists-section">
          <div class="feed-profile-section feed-following-list">
            <h4>Following List</h4>
            <ul id="followingList"></ul>
          </div>

          <div class="feed-profile-section feed-followers-list">
            <h4>Followers List</h4>
            <ul id="followerList"></ul>
          </div>
        </div>

        <div class="feed-profile-section feed-activity">
          <h4>Activity Feed</h4>
          <div id="communityActivity">Loading...</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const communityId = new URLSearchParams(window.location.search).get('id');
      const loggedInUser = JSON.parse(localStorage.getItem("echoloopUser"));
  
      if (!communityId) {
        window.location.href = 'feed.html';
        return;
      }
  
      const isOwnProfile = loggedInUser && loggedInUser.id == communityId;
  
      if (isOwnProfile) {
        document.getElementById('editAboutBtn').style.display = 'inline-block';
        document.getElementById('editLocationBtn').style.display = 'inline-block';
        document.getElementById('followBtn').style.display = 'none';
      }
  
      fetch(`/api/users/${communityId}/profile`)
        .then(res => res.json())
        .then(community => {
          if (community.role?.toLowerCase() !== 'event community') {
            alert('Invalid community profile');
            window.location.href = 'feed.html';
            return;
          }
  
          document.getElementById('communityName').textContent = community.username;
          document.getElementById('communityAbout').textContent = community.about || '—';
          document.getElementById('communityLocation').textContent = community.locations || '—';
          window.originalAbout = community.about || '';
          window.originalLocation = community.locations || '';
          if (isOwnProfile) {
            document.getElementById('aboutInput').value = community.about || '';
            document.getElementById('locationInput').value = community.locations || '';
          }
  
          // FOLLOW BUTTON LOGIC
          if (!isOwnProfile && loggedInUser) {
            fetch(`/api/users/${loggedInUser.id}/following`)
              .then(res => res.json())
              .then(following => {
                let alreadyFollowing = following.some(u => u.id == communityId);
                const followBtn = document.getElementById('followBtn');
                followBtn.style.display = 'inline-block';
                followBtn.textContent = alreadyFollowing ? 'Unfollow' : 'Follow';
  
                followBtn.onclick = () => {
                  const action = alreadyFollowing ? 'unfollow' : 'follow';
                  fetch(`/api/users/${loggedInUser.id}/${action}/${communityId}`, {
                    method: 'POST'
                  })
                    .then(res => {
                      if (res.ok) {
                        alreadyFollowing = !alreadyFollowing;
                        followBtn.textContent = alreadyFollowing ? 'Unfollow' : 'Follow';
                      } else {
                        alert('Follow action failed');
                      }
                    })
                    .catch(err => {
                      console.error('Follow error:', err);
                      alert('Follow failed');
                    });
                };
              });
          }
        });
  
      Promise.all([
        fetch(`/api/posts/user/${communityId}`).then(res => res.json()),
        fetch(`/api/events/by-user/${communityId}`).then(res => res.json())
      ])
      .then(([posts, events]) => {
        const container = document.getElementById('communityActivity');
        container.innerHTML = '';
        const allItems = [];
  
        posts.forEach(post => {
          allItems.push({
            type: 'post',
            createdAt: new Date(post.createdAt).getTime(),
            content: post.content,
            username: post.username,
            imageUrl: post.imageUrl,
            id: post.id
          });
        });
  
        events.forEach(event => {
          allItems.push({
            type: 'event',
            createdAt: new Date(event.createdAt).getTime(),
            title: event.title,
            genre: event.genre,
            location: event.location,
            eventDate: event.eventDate,
            id: event.id
          });
        });
  
        allItems.sort((a, b) => b.createdAt - a.createdAt);
  
        if (allItems.length === 0) {
          container.innerHTML = '<p class="feed-no-activity">No activity yet.</p>';
          return;
        }
  
        allItems.forEach(item => {
          const div = document.createElement('div');
          const timestamp = new Date(item.createdAt).toLocaleString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
  
          if (item.type === 'post') {
            div.className = 'feed-post';
            const imageHTML = item.imageUrl ? `<img src="${item.imageUrl}" alt="Post image" style="max-width: 100%; border-radius: 8px;" />` : '';
            div.innerHTML = `
              <h4>${item.username} <small>${timestamp}</small></h4>
              <p>${item.content}</p>
              ${imageHTML}
              ${isOwnProfile ? `
                <div class="feed-post-actions">
                  <button onclick="editPost(${item.id})" class="feed-button">Edit Post</button>
                  <button onclick="deletePost(${item.id})" class="feed-button">Delete Post</button>
                </div>
              ` : ''}
            `;
          } else {
            const eventDate = new Date(item.eventDate).toLocaleDateString('en-US', {
              weekday: 'long',
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            });
            div.className = 'feed-event';
            div.innerHTML = `
              <h4>
                <a href="event_detail.html?eventId=${item.id}">${item.title}</a>
                <small>Posted ${timestamp}</small>
              </h4>
              <p><strong>Genre:</strong> ${item.genre}</p>
              <p><strong>Location:</strong> ${item.location}</p>
              <p><strong>Event Date:</strong> ${eventDate}</p>
              ${isOwnProfile ? `
                <div class="feed-post-actions">
                  <button onclick="editEvent(${item.id})" class="feed-button">Edit Event</button>
                  <button onclick="deleteEvent(${item.id})" class="feed-button">Delete Event</button>
                </div>
              ` : ''}
            `;
          }
  
          container.appendChild(div);
        });
      });
  
      fetch(`/api/users/${communityId}/following`)
        .then(res => res.json())
        .then(users => {
          document.getElementById('followingCount').textContent = `${users.length} following`;
          const list = document.getElementById('followingList');
          list.innerHTML = '';
          users.forEach(user => {
            const li = document.createElement('li');
            const profileLink = user.role?.toLowerCase() === 'event community'
              ? `community_profile.html?id=${user.id}`
              : `profile.html?id=${user.id}`;
            li.innerHTML = `<a href="${profileLink}">${user.username}</a>`;
            list.appendChild(li);
          });
        });
  
      fetch(`/api/users/${communityId}/followers`)
        .then(res => res.json())
        .then(users => {
          document.getElementById('followerCount').textContent =
            `${users.length} follower${users.length !== 1 ? 's' : ''}`;
          const list = document.getElementById('followerList');
          list.innerHTML = '';
          users.forEach(user => {
            const li = document.createElement('li');
            const profileLink = user.role?.toLowerCase() === 'event community'
              ? `community_profile.html?id=${user.id}`
              : `profile.html?id=${user.id}`;
            li.innerHTML = `<a href="${profileLink}">${user.username}</a>`;
            list.appendChild(li);
          });
        });
    });
  
    function editAbout() {
      document.getElementById('aboutSection').style.display = 'none';
      document.getElementById('aboutEditSection').style.display = 'block';
    }
  
    function editLocation() {
      document.getElementById('locationSection').style.display = 'none';
      document.getElementById('locationEditSection').style.display = 'block';
    }
  
    function cancelEdit() {
      document.getElementById('aboutInput').value = window.originalAbout;
      document.getElementById('locationInput').value = window.originalLocation;
      document.getElementById('aboutSection').style.display = 'block';
      document.getElementById('locationSection').style.display = 'block';
      document.getElementById('aboutEditSection').style.display = 'none';
      document.getElementById('locationEditSection').style.display = 'none';
    }
  
    function saveProfile() {
      const loggedInUser = JSON.parse(localStorage.getItem("echoloopUser"));
      const updated = {
        about: document.getElementById('aboutInput').value,
        locations: document.getElementById('locationInput').value
      };
  
      fetch(`/api/users/${loggedInUser.id}/community-profile`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      })
      .then(res => {
        if (res.ok) {
          document.getElementById('communityAbout').textContent = updated.about || '—';
          document.getElementById('communityLocation').textContent = updated.locations || '—';
          window.originalAbout = updated.about;
          window.originalLocation = updated.locations;
          cancelEdit();
        } else {
          alert('Failed to update profile');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Failed to update profile');
      });
    }
  
    function editPost(postId) {
      window.location.href = `edit_post.html?id=${postId}`;
    }
  
    function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) return;
  
      fetch(`/api/posts/${postId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) window.location.reload();
          else alert('Failed to delete post');
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Failed to delete post');
        });
    }
  
    function editEvent(eventId) {
      window.location.href = `edit_event.html?id=${eventId}`;
    }
  
    function deleteEvent(eventId) {
      if (!confirm('Are you sure you want to delete this event?')) return;
  
      fetch(`/api/events/${eventId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) window.location.reload();
          else alert('Failed to delete event');
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Failed to delete event');
        });
    }
  
    document.getElementById('editAboutBtn').onclick = editAbout;
    document.getElementById('editLocationBtn').onclick = editLocation;
  </script>
  
  
</body>
</html> 